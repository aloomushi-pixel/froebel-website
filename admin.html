<!DOCTYPE html>
<html lang="es-MX">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Panel Administrativo ‚Äî Instituto Federico Froebel</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/wizard.css">
    <link rel="manifest" href="manifest.json">

    <style>
        /* Tab Navigation */
        .admin-tabs {
            display: flex;
            gap: var(--space-1);
            padding: 0 var(--space-2);
            background: var(--color-white);
            border-bottom: 2px solid var(--color-border-light);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .admin-tabs::-webkit-scrollbar {
            display: none;
        }

        .admin-tab {
            padding: var(--space-3) var(--space-5);
            font-size: var(--text-sm);
            font-weight: var(--weight-semibold);
            color: var(--color-text-light);
            border: none;
            background: none;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all var(--duration-fast);
            font-family: var(--font-body);
        }

        .admin-tab:hover {
            color: var(--color-primary);
            background: var(--color-primary-50);
        }

        .admin-tab--active {
            color: var(--color-primary-dark);
            border-bottom-color: var(--color-primary);
            background: var(--color-primary-50);
        }

        /* Tab Panels */
        .admin-panel {
            display: none;
        }

        .admin-panel--active {
            display: block;
        }

        /* Card grid for modules */
        .admin-module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--space-6);
        }

        .admin-module-card {
            background: var(--color-white);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-card);
            border: 1px solid var(--color-border-light);
        }

        .admin-module-card h3 {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            font-size: var(--text-lg);
        }

        /* Lead status badges */
        .lead-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--weight-semibold);
        }

        .lead-badge--new {
            background: #e0f2fe;
            color: #0369a1;
        }

        .lead-badge--contacted {
            background: #fef3c7;
            color: #92400e;
        }

        .lead-badge--tour {
            background: #ede9fe;
            color: #6d28d9;
        }

        .lead-badge--enrolled {
            background: #d1fae5;
            color: #065f46;
        }

        .lead-badge--lost {
            background: #fee2e2;
            color: #991b1b;
        }

        /* PWA Install */
        .pwa-banner {
            display: none;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: white;
            padding: var(--space-3) var(--space-6);
            text-align: center;
            font-size: var(--text-sm);
            align-items: center;
            justify-content: center;
            gap: var(--space-4);
        }

        .pwa-banner.show {
            display: flex;
        }

        .pwa-btn {
            background: white;
            color: var(--color-primary-dark);
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-weight: var(--weight-bold);
            cursor: pointer;
            font-size: var(--text-sm);
            font-family: var(--font-body);
        }

        @media (max-width: 768px) {
            .admin-tabs {
                padding: 0;
            }

            .admin-tab {
                padding: var(--space-2) var(--space-3);
                font-size: var(--text-xs);
            }
        }
    </style>
</head>

<body>
    <!-- PWA Install Banner -->
    <div class="pwa-banner" id="pwa-banner">
        üì± Instala el Panel como App &nbsp;
        <button class="pwa-btn" id="pwa-install-btn" onclick="installPWA()">Instalar</button>
        <button style="background:none;border:none;color:rgba(255,255,255,0.8);cursor:pointer;font-size:1rem;"
            onclick="document.getElementById('pwa-banner').classList.remove('show')">‚úï</button>
    </div>

    <!-- HEADER -->
    <header class="header" id="header">
        <div class="header__inner">
            <a href="index.html" class="header__logo"><svg width="44" height="44" viewBox="0 0 44 44" fill="none">
                    <rect width="44" height="44" rx="12" fill="#1a7a6d" /><text x="22" y="28" font-size="20"
                        fill="white" text-anchor="middle" font-family="Nunito" font-weight="800">F</text>
                </svg><span>Froebel Admin</span></a>
            <nav class="header__nav" id="main-nav">
                <span class="header__link" id="admin-user-email" style="cursor:default;"></span>
                <button class="btn btn--sm btn--secondary" onclick="handleLogout()" id="logout-btn"
                    style="display:none;">Cerrar sesi√≥n</button>
            </nav>
        </div>
    </header>

    <!-- LOGIN -->
    <div id="admin-login-section">
        <div class="admin-login">
            <div style="text-align:center; margin-bottom: var(--space-6);">
                <div style="font-size: 3rem; margin-bottom: var(--space-3);">üîê</div>
                <h2 style="margin-bottom: var(--space-2);">Panel Administrativo</h2>
                <p style="color: var(--color-text-muted); font-size: var(--text-sm);">Acceso exclusivo para
                    administraci√≥n Froebel</p>
            </div>

            <form id="login-form" style="display: flex; flex-direction: column; gap: var(--space-4);">
                <div class="wizard__field">
                    <label for="admin-email">Correo electr√≥nico</label>
                    <input type="email" id="admin-email" required placeholder="admin@froebelinstituto.com.mx">
                </div>
                <div class="wizard__field">
                    <label for="admin-password">Contrase√±a</label>
                    <input type="password" id="admin-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div id="login-error"
                    style="display:none; color: var(--color-accent); font-size: var(--text-sm); text-align: center;">
                </div>
                <button type="submit" class="btn btn--primary btn--lg" style="width:100%;">Iniciar sesi√≥n</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="admin-dashboard-section" style="display: none;">

        <!-- TABS -->
        <nav class="admin-tabs" id="admin-tabs">
            <button class="admin-tab admin-tab--active" data-tab="inscripciones"
                onclick="switchTab('inscripciones', this)">üìä Inscripciones</button>
            <button class="admin-tab" data-tab="leads" onclick="switchTab('leads', this)">üì• Leads</button>
            <button class="admin-tab" data-tab="padres" onclick="switchTab('padres', this)">üë®‚Äçüë©‚Äçüëß Padres</button>
            <button class="admin-tab" data-tab="alumnos" onclick="switchTab('alumnos', this)">üë∂ Alumnos</button>
            <button class="admin-tab" data-tab="documentos" onclick="switchTab('documentos', this)">üìÑ
                Documentos</button>
            <button class="admin-tab" data-tab="pagos" onclick="switchTab('pagos', this)">üí∞ Pagos</button>
            <button class="admin-tab" data-tab="config" onclick="switchTab('config', this)">‚öôÔ∏è Config</button>
        </nav>

        <!-- ========== TAB: INSCRIPCIONES ========== -->
        <div class="admin-panel admin-panel--active" id="panel-inscripciones">
            <div class="admin-dashboard">
                <div class="admin-header">
                    <h1>üìä Inscripciones</h1>
                    <button class="btn btn--primary btn--sm" onclick="loadEnrollments()">üîÑ Actualizar</button>
                </div>

                <div class="admin-stats" id="admin-stats">
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="stat-total">0</div>
                        <div class="admin-stat-card__label">Total</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="stat-pending"
                            style="color: var(--color-secondary-dark);">0</div>
                        <div class="admin-stat-card__label">Pendientes</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="stat-approved"
                            style="color: var(--color-nature-dark);">0</div>
                        <div class="admin-stat-card__label">Aprobadas</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="stat-revenue" style="color: var(--color-primary);">$0
                        </div>
                        <div class="admin-stat-card__label">Ingresos</div>
                    </div>
                </div>

                <div class="admin-filters">
                    <button class="admin-filter-btn admin-filter-btn--active"
                        onclick="filterEnrollments(null, this)">Todas</button>
                    <button class="admin-filter-btn" onclick="filterEnrollments('pending', this)">‚è≥ Pendientes</button>
                    <button class="admin-filter-btn" onclick="filterEnrollments('documents_review', this)">üìÑ En
                        revisi√≥n</button>
                    <button class="admin-filter-btn" onclick="filterEnrollments('approved', this)">‚úÖ Aprobadas</button>
                    <button class="admin-filter-btn" onclick="filterEnrollments('rejected', this)">‚ùå Rechazadas</button>
                </div>

                <table class="admin-table" id="enrollments-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Alumno</th>
                            <th>Tutor</th>
                            <th>Programa</th>
                            <th>Plan</th>
                            <th>Docs</th>
                            <th>Pago</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="enrollments-tbody">
                        <tr>
                            <td colspan="9"
                                style="text-align:center; padding: var(--space-12); color: var(--color-text-muted);">
                                Cargando inscripciones...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== TAB: LEADS ========== -->
        <div class="admin-panel" id="panel-leads">
            <div class="admin-dashboard">
                <div class="admin-header">
                    <h1>üì• Leads</h1>
                    <div style="display:flex;gap:var(--space-3);">
                        <button class="btn btn--primary btn--sm" onclick="showNewLeadForm()">‚ûï Nuevo Lead</button>
                        <button class="btn btn--secondary btn--sm" onclick="loadLeads()">üîÑ Actualizar</button>
                    </div>
                </div>

                <div class="admin-stats" id="leads-stats">
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="leads-total">0</div>
                        <div class="admin-stat-card__label">Total Leads</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="leads-new" style="color:#0369a1;">0</div>
                        <div class="admin-stat-card__label">Nuevos</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="leads-contacted" style="color:#92400e;">0</div>
                        <div class="admin-stat-card__label">Contactados</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="leads-enrolled" style="color:#065f46;">0</div>
                        <div class="admin-stat-card__label">Inscritos</div>
                    </div>
                </div>

                <table class="admin-table" id="leads-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Nombre</th>
                            <th>Tel√©fono</th>
                            <th>Email</th>
                            <th>Edad hijo</th>
                            <th>Programa</th>
                            <th>Fuente</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="leads-tbody">
                        <tr>
                            <td colspan="9"
                                style="text-align:center;padding:var(--space-12);color:var(--color-text-muted);">
                                Cargando leads...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== TAB: PADRES ========== -->
        <div class="admin-panel" id="panel-padres">
            <div class="admin-dashboard">
                <div class="admin-header">
                    <h1>üë®‚Äçüë©‚Äçüëß Directorio de Padres</h1>
                    <button class="btn btn--secondary btn--sm" onclick="loadGuardians()">üîÑ Actualizar</button>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Tel√©fono</th>
                            <th>Direcci√≥n</th>
                            <th>Contacto Emergencia</th>
                            <th>Hijos</th>
                        </tr>
                    </thead>
                    <tbody id="guardians-tbody">
                        <tr>
                            <td colspan="6"
                                style="text-align:center;padding:var(--space-12);color:var(--color-text-muted);">
                                Cargando padres...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== TAB: ALUMNOS ========== -->
        <div class="admin-panel" id="panel-alumnos">
            <div class="admin-dashboard">
                <div class="admin-header">
                    <h1>üë∂ Alumnos</h1>
                    <button class="btn btn--secondary btn--sm" onclick="loadStudents()">üîÑ Actualizar</button>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Nacimiento</th>
                            <th>Edad</th>
                            <th>CURP</th>
                            <th>Sangre</th>
                            <th>Alergias</th>
                            <th>Programa</th>
                        </tr>
                    </thead>
                    <tbody id="students-tbody">
                        <tr>
                            <td colspan="7"
                                style="text-align:center;padding:var(--space-12);color:var(--color-text-muted);">
                                Cargando alumnos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== TAB: DOCUMENTOS ========== -->
        <div class="admin-panel" id="panel-documentos">
            <div class="admin-dashboard">
                <div class="admin-header">
                    <h1>üìÑ Documentos</h1>
                    <button class="btn btn--secondary btn--sm" onclick="loadDocuments()">üîÑ Actualizar</button>
                </div>
                <div class="admin-stats">
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="docs-total">0</div>
                        <div class="admin-stat-card__label">Total Docs</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="docs-verified" style="color:#065f46;">0</div>
                        <div class="admin-stat-card__label">Verificados</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="docs-pending" style="color:#92400e;">0</div>
                        <div class="admin-stat-card__label">Pendientes</div>
                    </div>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Alumno</th>
                            <th>Tipo</th>
                            <th>Archivo</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="docs-tbody">
                        <tr>
                            <td colspan="6"
                                style="text-align:center;padding:var(--space-12);color:var(--color-text-muted);">
                                Cargando documentos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== TAB: PAGOS ========== -->
        <div class="admin-panel" id="panel-pagos">
            <div class="admin-dashboard">
                <div class="admin-header">
                    <h1>üí∞ Pagos</h1>
                    <button class="btn btn--secondary btn--sm" onclick="loadPayments()">üîÑ Actualizar</button>
                </div>
                <div class="admin-stats">
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="pay-total">$0</div>
                        <div class="admin-stat-card__label">Total Recaudado</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="pay-count">0</div>
                        <div class="admin-stat-card__label">Pagos</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-card__number" id="pay-pending-count" style="color:#92400e;">0</div>
                        <div class="admin-stat-card__label">Pendientes</div>
                    </div>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Alumno</th>
                            <th>Tipo</th>
                            <th>Monto</th>
                            <th>M√©todo</th>
                            <th>Estado</th>
                            <th>Referencia</th>
                        </tr>
                    </thead>
                    <tbody id="payments-tbody">
                        <tr>
                            <td colspan="7"
                                style="text-align:center;padding:var(--space-12);color:var(--color-text-muted);">
                                Cargando pagos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== TAB: CONFIG ========== -->
        <div class="admin-panel" id="panel-config">
            <div class="admin-dashboard">
                <div class="admin-header">
                    <h1>‚öôÔ∏è Configuraci√≥n</h1>
                </div>
                <div class="admin-module-grid">
                    <div class="admin-module-card">
                        <h3>üì± PWA</h3>
                        <p style="color:var(--color-text-light);font-size:var(--text-sm);margin-bottom:var(--space-4);">
                            Instala el panel como aplicaci√≥n nativa en tu dispositivo para acceso r√°pido.</p>
                        <button class="btn btn--primary btn--sm" id="config-pwa-btn" onclick="installPWA()">Instalar
                            App</button>
                    </div>
                    <div class="admin-module-card">
                        <h3>üîë Cuenta</h3>
                        <p style="color:var(--color-text-light);font-size:var(--text-sm);margin-bottom:var(--space-4);">
                            Sesi√≥n activa como: <strong id="config-email"></strong></p>
                        <button class="btn btn--secondary btn--sm" onclick="handleLogout()">Cerrar Sesi√≥n</button>
                    </div>
                    <div class="admin-module-card">
                        <h3>üìä Estad√≠sticas</h3>
                        <p style="color:var(--color-text-light);font-size:var(--text-sm);">
                            <span id="config-stats">Cargando...</span>
                        </p>
                    </div>
                    <div class="admin-module-card">
                        <h3>üåê Sitio Web</h3>
                        <p style="color:var(--color-text-light);font-size:var(--text-sm);margin-bottom:var(--space-4);">
                            Accede al sitio p√∫blico del instituto.</p>
                        <a href="index.html" class="btn btn--secondary btn--sm">Ver Sitio ‚Üí</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ENROLLMENT DETAIL MODAL -->
    <div id="enrollment-modal"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; overflow-y:auto;">
        <div
            style="max-width:700px; margin:80px auto; background:white; border-radius:var(--radius-2xl); padding:var(--space-8); position:relative;">
            <button onclick="closeModal()"
                style="position:absolute;top:var(--space-4);right:var(--space-4);background:none;border:none;font-size:1.5rem;cursor:pointer;">‚úï</button>
            <div id="modal-content"></div>
        </div>
    </div>

    <!-- NEW LEAD MODAL -->
    <div id="lead-modal"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; overflow-y:auto;">
        <div
            style="max-width:500px; margin:80px auto; background:white; border-radius:var(--radius-2xl); padding:var(--space-8); position:relative;">
            <button onclick="closeLeadModal()"
                style="position:absolute;top:var(--space-4);right:var(--space-4);background:none;border:none;font-size:1.5rem;cursor:pointer;">‚úï</button>
            <h2 style="margin-bottom:var(--space-6);">‚ûï Nuevo Lead</h2>
            <form id="lead-form" style="display:flex;flex-direction:column;gap:var(--space-4);">
                <div class="wizard__field">
                    <label>Nombre completo *</label>
                    <input type="text" id="lead-name" required>
                </div>
                <div class="wizard__field">
                    <label>Tel√©fono</label>
                    <input type="tel" id="lead-phone">
                </div>
                <div class="wizard__field">
                    <label>Email</label>
                    <input type="email" id="lead-email">
                </div>
                <div class="wizard__field">
                    <label>Edad del hijo</label>
                    <input type="text" id="lead-age" placeholder="Ej: 2 a√±os, 3 a√±os">
                </div>
                <div class="wizard__field">
                    <label>Programa de inter√©s</label>
                    <select id="lead-program">
                        <option value="">Seleccionar...</option>
                        <option value="maternal">Maternal (2-3 a√±os)</option>
                        <option value="preescolar">Preescolar (3-5 a√±os)</option>
                        <option value="extendido">Horario Extendido</option>
                    </select>
                </div>
                <div class="wizard__field">
                    <label>Fuente</label>
                    <select id="lead-source">
                        <option value="website">Sitio Web</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="instagram">Instagram</option>
                        <option value="facebook">Facebook</option>
                        <option value="referido">Referido</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div class="wizard__field">
                    <label>Notas</label>
                    <textarea id="lead-notes" rows="3" style="resize:vertical;"></textarea>
                </div>
                <button type="submit" class="btn btn--primary btn--lg" style="width:100%;">Guardar Lead</button>
            </form>
        </div>
    </div>

    <!-- CDN: Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="scripts/supabase-client.js"></script>

    <script>
        /* === TAB MANAGEMENT === */
        function switchTab(tab, btn) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('admin-tab--active'));
            document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('admin-panel--active'));
            btn.classList.add('admin-tab--active');
            document.getElementById('panel-' + tab).classList.add('admin-panel--active');

            // Lazy-load data per tab
            const loaders = {
                inscripciones: loadEnrollments,
                leads: loadLeads,
                padres: loadGuardians,
                alumnos: loadStudents,
                documentos: loadDocuments,
                pagos: loadPayments,
                config: loadConfig
            };
            if (loaders[tab]) loaders[tab]();
        }

        /* === AUTH === */
        let allEnrollments = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const session = await getAdminSession();
            if (session) showDashboard(session.user.email);
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('login-error');

            try {
                errorEl.style.display = 'none';
                const data = await adminLogin(email, password);
                showDashboard(data.user.email);
            } catch (err) {
                errorEl.textContent = 'Credenciales incorrectas: ' + err.message;
                errorEl.style.display = 'block';
            }
        });

        async function handleLogout() {
            await adminLogout();
            document.getElementById('admin-login-section').style.display = 'block';
            document.getElementById('admin-dashboard-section').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'none';
            document.getElementById('admin-user-email').textContent = '';
        }

        function showDashboard(email) {
            document.getElementById('admin-login-section').style.display = 'none';
            document.getElementById('admin-dashboard-section').style.display = 'block';
            document.getElementById('admin-user-email').textContent = email;
            document.getElementById('logout-btn').style.display = 'inline-flex';
            if (document.getElementById('config-email')) document.getElementById('config-email').textContent = email;
            loadEnrollments();
        }

        /* === ENROLLMENTS (existing) === */
        async function loadEnrollments() {
            try {
                allEnrollments = await listEnrollments();
                updateStats();
                renderEnrollmentTable(allEnrollments);
            } catch (err) {
                console.error('Error loading enrollments:', err);
                document.getElementById('enrollments-tbody').innerHTML = `<tr><td colspan="9" style="text-align:center;color:var(--color-accent);padding:var(--space-8);">Error: ${err.message}</td></tr>`;
            }
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = allEnrollments.length;
            document.getElementById('stat-pending').textContent = allEnrollments.filter(e => ['pending', 'documents_review', 'payment_pending'].includes(e.status)).length;
            document.getElementById('stat-approved').textContent = allEnrollments.filter(e => e.status === 'approved').length;
            const revenue = allEnrollments.reduce((sum, e) => {
                const payments = e.froebel_payments || [];
                return sum + payments.filter(p => p.status === 'completed').reduce((s, p) => s + Number(p.amount), 0);
            }, 0);
            document.getElementById('stat-revenue').textContent = formatPrice(revenue);
        }

        function renderEnrollmentTable(data) {
            const tbody = document.getElementById('enrollments-tbody');
            if (!data.length) { tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:var(--space-12);color:var(--color-text-muted);">No hay inscripciones</td></tr>`; return; }

            tbody.innerHTML = data.map(e => {
                const s = e.froebel_students || {}, g = e.froebel_guardians || {};
                const docs = e.froebel_documents || [], pays = e.froebel_payments || [];
                const paid = pays.filter(p => p.status === 'completed');
                const badges = { pending: '‚è≥ Pendiente', documents_review: 'üìÑ En revisi√≥n', payment_pending: 'üí≥ Pago pendiente', approved: '‚úÖ Aprobada', rejected: '‚ùå Rechazada', cancelled: 'üö´ Cancelada' };
                return `<tr>
                    <td>${new Date(e.created_at).toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' })}</td>
                    <td><strong>${s.full_name || 'N/A'}</strong><br><span style="font-size:var(--text-xs);color:var(--color-text-muted);">${s.date_of_birth || ''}</span></td>
                    <td>${g.full_name || 'N/A'}<br><span style="font-size:var(--text-xs);color:var(--color-text-muted);">${g.phone || ''}</span></td>
                    <td>${formatProgram(e.program)}</td>
                    <td>${e.plan === 'plus' ? 'Plus' : 'Base'}</td>
                    <td>${docs.length}/6</td>
                    <td>${paid.length > 0 ? '‚úÖ' : '‚è≥'}</td>
                    <td><span class="wizard__status-badge wizard__status-badge--${e.status === 'approved' ? 'approved' : e.status === 'rejected' ? 'rejected' : 'pending'}">${badges[e.status] || e.status}</span></td>
                    <td style="white-space:nowrap;">
                        <button class="admin-btn admin-btn--view" onclick="viewDetail('${e.id}')">üëÅ</button>
                        ${e.status !== 'approved' && e.status !== 'rejected' ? `<button class="admin-btn admin-btn--approve" onclick="handleApprove('${e.id}')">‚úì</button><button class="admin-btn admin-btn--reject" onclick="handleReject('${e.id}')">‚úó</button>` : ''}
                    </td></tr>`;
            }).join('');
        }

        function filterEnrollments(status, btn) {
            document.querySelectorAll('.admin-filter-btn').forEach(b => b.classList.remove('admin-filter-btn--active'));
            btn.classList.add('admin-filter-btn--active');
            renderEnrollmentTable(status ? allEnrollments.filter(e => e.status === status) : allEnrollments);
        }

        /* === LEADS === */
        let allLeads = [];

        async function loadLeads() {
            try {
                const { data, error } = await getSupabase().from('froebel_leads').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                allLeads = data || [];
                updateLeadStats();
                renderLeadsTable();
            } catch (err) {
                console.error('Leads error:', err);
                document.getElementById('leads-tbody').innerHTML = `<tr><td colspan="9" style="text-align:center;color:var(--color-text-muted);padding:var(--space-8);">La tabla de leads a√∫n no existe. Ejecuta la migraci√≥n de Supabase.</td></tr>`;
            }
        }

        function updateLeadStats() {
            document.getElementById('leads-total').textContent = allLeads.length;
            document.getElementById('leads-new').textContent = allLeads.filter(l => l.status === 'new').length;
            document.getElementById('leads-contacted').textContent = allLeads.filter(l => l.status === 'contacted').length;
            document.getElementById('leads-enrolled').textContent = allLeads.filter(l => l.status === 'enrolled').length;
        }

        function renderLeadsTable() {
            const tbody = document.getElementById('leads-tbody');
            if (!allLeads.length) { tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:var(--space-12);color:var(--color-text-muted);">No hay leads registrados</td></tr>'; return; }

            const badgeMap = { new: 'lead-badge--new', contacted: 'lead-badge--contacted', tour_scheduled: 'lead-badge--tour', enrolled: 'lead-badge--enrolled', lost: 'lead-badge--lost' };
            const nameMap = { new: 'Nuevo', contacted: 'Contactado', tour_scheduled: 'Tour', enrolled: 'Inscrito', lost: 'Perdido' };

            tbody.innerHTML = allLeads.map(l => `<tr>
                <td>${new Date(l.created_at).toLocaleDateString('es-MX', { day: '2-digit', month: 'short' })}</td>
                <td><strong>${l.full_name}</strong></td>
                <td>${l.phone || '‚Äî'}</td>
                <td>${l.email || '‚Äî'}</td>
                <td>${l.child_age || '‚Äî'}</td>
                <td>${l.program_interest || '‚Äî'}</td>
                <td>${l.source || '‚Äî'}</td>
                <td><span class="lead-badge ${badgeMap[l.status] || ''}">${nameMap[l.status] || l.status}</span></td>
                <td style="white-space:nowrap;">
                    <select onchange="updateLeadStatus('${l.id}',this.value)" style="font-size:var(--text-xs);padding:2px 6px;border-radius:var(--radius-md);border:1px solid var(--color-border-light);">
                        ${['new', 'contacted', 'tour_scheduled', 'enrolled', 'lost'].map(s => `<option value="${s}" ${l.status === s ? 'selected' : ''}>${nameMap[s]}</option>`).join('')}
                    </select>
                </td></tr>`).join('');
        }

        async function updateLeadStatus(id, status) {
            try {
                const { error } = await getSupabase().from('froebel_leads').update({ status, updated_at: new Date().toISOString() }).eq('id', id);
                if (error) throw error;
                await loadLeads();
            } catch (err) { alert('Error: ' + err.message); }
        }

        function showNewLeadForm() {
            document.getElementById('lead-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeLeadModal() {
            document.getElementById('lead-modal').style.display = 'none';
            document.body.style.overflow = '';
        }

        document.getElementById('lead-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const { error } = await getSupabase().from('froebel_leads').insert({
                    full_name: document.getElementById('lead-name').value,
                    phone: document.getElementById('lead-phone').value,
                    email: document.getElementById('lead-email').value,
                    child_age: document.getElementById('lead-age').value,
                    program_interest: document.getElementById('lead-program').value,
                    source: document.getElementById('lead-source').value,
                    notes: document.getElementById('lead-notes').value
                });
                if (error) throw error;
                closeLeadModal();
                document.getElementById('lead-form').reset();
                await loadLeads();
            } catch (err) { alert('Error creando lead: ' + err.message); }
        });

        document.getElementById('lead-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeLeadModal();
        });

        /* === PADRES (Guardians) === */
        async function loadGuardians() {
            try {
                const { data, error } = await getSupabase().from('froebel_guardians').select('*, froebel_enrollments(froebel_students(full_name))');
                if (error) throw error;
                const tbody = document.getElementById('guardians-tbody');
                if (!data.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:var(--space-12);color:var(--color-text-muted);">No hay padres registrados</td></tr>'; return; }

                tbody.innerHTML = data.map(g => {
                    const kids = (g.froebel_enrollments || []).map(e => e.froebel_students?.full_name).filter(Boolean).join(', ');
                    return `<tr>
                        <td><strong>${g.full_name}</strong></td>
                        <td>${g.email || '‚Äî'}</td>
                        <td>${g.phone || '‚Äî'}</td>
                        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;">${g.address || '‚Äî'}</td>
                        <td>${g.emergency_contact_name || '‚Äî'}<br><span style="font-size:var(--text-xs);">${g.emergency_contact_phone || ''}</span></td>
                        <td>${kids || '‚Äî'}</td></tr>`;
                }).join('');
            } catch (err) {
                document.getElementById('guardians-tbody').innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--color-accent);padding:var(--space-8);">Error: ${err.message}</td></tr>`;
            }
        }

        /* === ALUMNOS (Students) === */
        async function loadStudents() {
            try {
                const { data, error } = await getSupabase().from('froebel_students').select('*, froebel_enrollments(program)');
                if (error) throw error;
                const tbody = document.getElementById('students-tbody');
                if (!data.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:var(--space-12);color:var(--color-text-muted);">No hay alumnos registrados</td></tr>'; return; }

                tbody.innerHTML = data.map(s => {
                    const age = s.date_of_birth ? Math.floor((Date.now() - new Date(s.date_of_birth)) / 31557600000) : '‚Äî';
                    const prog = (s.froebel_enrollments || []).map(e => formatProgram(e.program)).join(', ');
                    return `<tr>
                        <td><strong>${s.full_name}</strong></td>
                        <td>${s.date_of_birth || '‚Äî'}</td>
                        <td>${age} a√±os</td>
                        <td style="font-size:var(--text-xs);">${s.curp || '‚Äî'}</td>
                        <td>${s.blood_type || '‚Äî'}</td>
                        <td>${s.allergies || 'Ninguna'}</td>
                        <td>${prog || '‚Äî'}</td></tr>`;
                }).join('');
            } catch (err) {
                document.getElementById('students-tbody').innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--color-accent);padding:var(--space-8);">Error: ${err.message}</td></tr>`;
            }
        }

        /* === DOCUMENTOS === */
        async function loadDocuments() {
            try {
                const { data, error } = await getSupabase().from('froebel_documents').select('*, froebel_enrollments(froebel_students(full_name))').order('created_at', { ascending: false });
                if (error) throw error;

                document.getElementById('docs-total').textContent = data.length;
                document.getElementById('docs-verified').textContent = data.filter(d => d.status === 'verified').length;
                document.getElementById('docs-pending').textContent = data.filter(d => d.status !== 'verified').length;

                const tbody = document.getElementById('docs-tbody');
                if (!data.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:var(--space-12);color:var(--color-text-muted);">No hay documentos</td></tr>'; return; }

                tbody.innerHTML = data.map(d => {
                    const studentName = d.froebel_enrollments?.froebel_students?.full_name || 'N/A';
                    return `<tr>
                        <td>${studentName}</td>
                        <td>${(d.document_type || '').replace(/_/g, ' ')}</td>
                        <td style="font-size:var(--text-xs);">${d.file_name || '‚Äî'}</td>
                        <td>${d.status === 'verified' ? '‚úÖ Verificado' : d.status === 'rejected' ? '‚ùå Rechazado' : 'üìé Pendiente'}</td>
                        <td>${d.created_at ? new Date(d.created_at).toLocaleDateString('es-MX', { day: '2-digit', month: 'short' }) : '‚Äî'}</td>
                        <td>
                            ${d.file_url ? `<a href="${d.file_url}" target="_blank" class="admin-btn admin-btn--view" style="text-decoration:none;">üì•</a>` : ''}
                            ${d.status !== 'verified' ? `<button class="admin-btn admin-btn--approve" onclick="verifyDoc('${d.id}')">‚úì</button>` : ''}
                        </td></tr>`;
                }).join('');
            } catch (err) {
                document.getElementById('docs-tbody').innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--color-accent);padding:var(--space-8);">Error: ${err.message}</td></tr>`;
            }
        }

        async function verifyDoc(id) {
            try {
                const { error } = await getSupabase().from('froebel_documents').update({ status: 'verified' }).eq('id', id);
                if (error) throw error;
                await loadDocuments();
            } catch (err) { alert('Error: ' + err.message); }
        }

        /* === PAGOS === */
        async function loadPayments() {
            try {
                const { data, error } = await getSupabase().from('froebel_payments').select('*, froebel_enrollments(froebel_students(full_name))').order('created_at', { ascending: false });
                if (error) throw error;

                const completed = data.filter(p => p.status === 'completed');
                const totalAmount = completed.reduce((s, p) => s + Number(p.amount), 0);

                document.getElementById('pay-total').textContent = formatPrice(totalAmount);
                document.getElementById('pay-count').textContent = completed.length;
                document.getElementById('pay-pending-count').textContent = data.filter(p => p.status !== 'completed').length;

                const tbody = document.getElementById('payments-tbody');
                if (!data.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:var(--space-12);color:var(--color-text-muted);">No hay pagos registrados</td></tr>'; return; }

                tbody.innerHTML = data.map(p => {
                    const studentName = p.froebel_enrollments?.froebel_students?.full_name || 'N/A';
                    return `<tr>
                        <td>${p.created_at ? new Date(p.created_at).toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' }) : '‚Äî'}</td>
                        <td>${studentName}</td>
                        <td>${p.payment_type === 'inscription' ? 'Inscripci√≥n' : 'Mensualidad'}</td>
                        <td><strong>${formatPrice(p.amount)}</strong></td>
                        <td>${p.payment_method || '‚Äî'}</td>
                        <td>${p.status === 'completed' ? '‚úÖ Pagado' : '‚è≥ Pendiente'}</td>
                        <td style="font-size:var(--text-xs);">${p.stripe_payment_id || '‚Äî'}</td></tr>`;
                }).join('');
            } catch (err) {
                document.getElementById('payments-tbody').innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--color-accent);padding:var(--space-8);">Error: ${err.message}</td></tr>`;
            }
        }

        /* === CONFIG === */
        async function loadConfig() {
            const email = document.getElementById('admin-user-email').textContent;
            if (document.getElementById('config-email')) document.getElementById('config-email').textContent = email;

            try {
                const [enr, students, guardians] = await Promise.all([
                    getSupabase().from('froebel_enrollments').select('id', { count: 'exact' }),
                    getSupabase().from('froebel_students').select('id', { count: 'exact' }),
                    getSupabase().from('froebel_guardians').select('id', { count: 'exact' })
                ]);
                document.getElementById('config-stats').innerHTML = `
                    üìä ${enr.count || 0} inscripciones ¬∑ üë∂ ${students.count || 0} alumnos ¬∑ üë®‚Äçüë©‚Äçüëß ${guardians.count || 0} padres
                `;
            } catch (e) {
                document.getElementById('config-stats').textContent = 'Error cargando estad√≠sticas';
            }
        }

        /* === DETAIL MODAL (enrollments) === */
        function viewDetail(id) {
            const e = allEnrollments.find(x => x.id === id);
            if (!e) return;
            const s = e.froebel_students || {}, g = e.froebel_guardians || {};
            const docs = e.froebel_documents || [], payments = e.froebel_payments || [];

            document.getElementById('modal-content').innerHTML = `
                <h2 style="margin-bottom:var(--space-6);">Detalle de Inscripci√≥n</h2>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-6);margin-bottom:var(--space-6);">
                    <div>
                        <h4 style="color:var(--color-text-muted);font-size:var(--text-xs);text-transform:uppercase;margin-bottom:var(--space-2);">Alumno</h4>
                        <p><strong>${s.full_name || ''}</strong></p>
                        <p>Nacimiento: ${s.date_of_birth || ''}</p>
                        <p>CURP: ${s.curp || 'No proporcionado'}</p>
                        <p>Sangre: ${s.blood_type || 'No proporcionado'}</p>
                        <p>Alergias: ${s.allergies || 'Ninguna'}</p>
                    </div>
                    <div>
                        <h4 style="color:var(--color-text-muted);font-size:var(--text-xs);text-transform:uppercase;margin-bottom:var(--space-2);">Tutor</h4>
                        <p><strong>${g.full_name || ''}</strong></p>
                        <p>üìß ${g.email || ''}</p>
                        <p>üìû ${g.phone || ''}</p>
                        <p>üìç ${g.address || 'No proporcionado'}</p>
                        <p>üÜò ${g.emergency_contact_name || ''} ‚Äî ${g.emergency_contact_phone || ''}</p>
                    </div>
                </div>
                <h4 style="margin-bottom:var(--space-3);">üìÑ Documentos (${docs.length})</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-3);margin-bottom:var(--space-6);">
                    ${docs.map(d => `<div style="display:flex;align-items:center;gap:var(--space-2);padding:var(--space-3);background:var(--color-bg);border-radius:var(--radius-md);font-size:var(--text-sm);"><span>${d.status === 'verified' ? '‚úÖ' : 'üìé'}</span><span>${(d.document_type || '').replace(/_/g, ' ')}</span></div>`).join('') || '<p style="color:var(--color-text-muted);grid-column:1/-1;">Sin documentos</p>'}
                </div>
                <h4 style="margin-bottom:var(--space-3);">üí∞ Pagos (${payments.length})</h4>
                <div style="margin-bottom:var(--space-6);">
                    ${payments.map(p => `<div style="display:flex;justify-content:space-between;padding:var(--space-3);border-bottom:1px solid var(--color-border-light);font-size:var(--text-sm);"><span>${p.payment_type === 'inscription' ? 'Inscripci√≥n' : 'Mensualidad'}</span><span>${formatPrice(p.amount)}</span><span>${p.status === 'completed' ? '‚úÖ' : '‚è≥'} ${p.payment_method || ''}</span></div>`).join('') || '<p style="color:var(--color-text-muted);">Sin pagos registrados</p>'}
                </div>
                <div style="display:flex;gap:var(--space-3);justify-content:center;">
                    ${e.status !== 'approved' ? `<button class="btn btn--primary" onclick="handleApprove('${e.id}');closeModal();">‚úÖ Aprobar</button>` : ''}
                    ${e.status !== 'rejected' ? `<button class="btn btn--secondary" style="border-color:var(--color-accent);color:var(--color-accent);" onclick="handleReject('${e.id}');closeModal();">‚ùå Rechazar</button>` : ''}
                </div>`;

            document.getElementById('enrollment-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('enrollment-modal').style.display = 'none';
            document.body.style.overflow = '';
        }

        async function handleApprove(id) {
            if (!confirm('¬øAprobar esta inscripci√≥n?')) return;
            try { await approveEnrollment(id, 'Aprobada por admin'); await loadEnrollments(); } catch (err) { alert('Error: ' + err.message); }
        }

        async function handleReject(id) {
            const reason = prompt('Motivo del rechazo:');
            if (!reason) return;
            try { await rejectEnrollment(id, reason); await loadEnrollments(); } catch (err) { alert('Error: ' + err.message); }
        }

        document.getElementById('enrollment-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        });

        /* === HELPERS === */
        function formatProgram(p) {
            return { maternal: 'Maternal', preescolar_1: 'Preesc. 1', preescolar_2: 'Preesc. 2', preescolar_3: 'Preesc. 3' }[p] || p;
        }

        function formatPrice(amount) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 0 }).format(amount);
        }

        /* === PWA INSTALL === */
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwa-banner').classList.add('show');
        });

        async function installPWA() {
            if (!deferredPrompt) {
                alert('La instalaci√≥n PWA no est√° disponible. Aseg√∫rate de acceder por HTTPS.');
                return;
            }
            deferredPrompt.prompt();
            const result = await deferredPrompt.userChoice;
            if (result.outcome === 'accepted') {
                document.getElementById('pwa-banner').classList.remove('show');
            }
            deferredPrompt = null;
        }

        window.addEventListener('appinstalled', () => {
            document.getElementById('pwa-banner').classList.remove('show');
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => { });
        }
    </script>
</body>

</html>